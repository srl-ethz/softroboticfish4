Copied a different version that has some needed macros public instead of protected